events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:8000;
    }

    upstream animal_detector {
        server animal-detector:8001;
    }

    upstream language_detector {
        server language-detector:8002;
    }

    upstream downscale {
        server downscale:8003;
    }

    upstream subtitles {
        server subtitles:8004;
    }

    upstream video_merger {
        server video-merger:8005;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=2r/s;

    server {
        listen 80;
        server_name _;

        client_max_body_size 5G;
        
        # Timeouts pour les uploads/downloads longs
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # ============================================
        # ROUTES API PRINCIPALE
        # ============================================
        location / {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ============================================
        # ROUTES MICROSERVICES (DEBUG)
        # ============================================
        location /animal-detector/ {
            proxy_pass http://animal_detector/;
            proxy_set_header Host $host;
        }

        location /language-detector/ {
            proxy_pass http://language_detector/;
            proxy_set_header Host $host;
        }

        location /downscale/ {
            proxy_pass http://downscale/;
            proxy_set_header Host $host;
        }

        location /subtitles/ {
            proxy_pass http://subtitles/;
            proxy_set_header Host $host;
        }

        location /video-merger/ {
            proxy_pass http://video_merger/;
            proxy_set_header Host $host;
        }

        # ============================================
        # UPLOAD ENDPOINT (Avec rate limiting)
        # ============================================
        location /video/upload {
            limit_req zone=upload_limit burst=5 nodelay;
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
            proxy_request_buffering off;
        }

        # ============================================
        # HEALTH CHECK
        # ============================================
        location /health {
            access_log off;
            proxy_pass http://api;
        }

        # ============================================
        # STATIC FILES
        # ============================================
        location /static/ {
            proxy_pass http://api;
            proxy_cache_valid 200 1h;
            add_header Cache-Control "public, max-age=3600";
        }

        # ============================================
        # MÉTRIQUES (JSON)
        # ============================================
        location /metrics {
            proxy_pass http://api;
            access_log off;
        }
    }

    # HTTPS (à configurer avec certbot)
    # server {
    #     listen 443 ssl http2;
    #     server_name yourdomain.com;
    #     
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     
    #     # ... same config as above
    # }
}
